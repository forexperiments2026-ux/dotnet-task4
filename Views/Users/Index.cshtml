@model Task4.Models.UserManagementViewModel
@{
    ViewData["Title"] = "User management";
    var statusSuccess = TempData["StatusSuccess"] as string;
    var statusError = TempData["StatusError"] as string;
}

<section class="app-shell">
    <div class="d-flex flex-column flex-xl-row justify-content-between gap-3 mb-3">
        <div>
            <h1 class="h4 mb-1">User management</h1>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <span class="badge text-bg-light border">Total: @Model.TotalUsers</span>
            <span class="badge text-bg-light border">Active: @Model.ActiveUsers</span>
            <span class="badge text-bg-light border">Blocked: @Model.BlockedUsers</span>
            <span class="badge text-bg-light border">Unverified: @Model.UnverifiedUsers</span>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(statusSuccess))
    {
        <div class="alert alert-success" role="status">@statusSuccess</div>
    }
    @if (!string.IsNullOrWhiteSpace(statusError))
    {
        <div class="alert alert-danger" role="status">@statusError</div>
    }

    <form method="post" asp-controller="Users" asp-action="Index">
        @Html.AntiForgeryToken()
        <div class="toolbar card shadow-sm mb-3">
            <div class="card-body d-flex flex-wrap align-items-center gap-2">
                <button class="btn btn-outline-dark btn-sm toolbar-selection-action" type="submit" name="operation" value="block">ðŸ”’ Block</button>
                <button class="btn btn-outline-secondary btn-sm toolbar-selection-action" type="submit" name="operation" value="unblock" title="Unblock selected users" data-bs-toggle="tooltip" data-bs-placement="bottom">ðŸ”“</button>
                <button class="btn btn-outline-secondary btn-sm toolbar-selection-action" type="submit" name="operation" value="delete" title="Delete selected users" data-bs-toggle="tooltip" data-bs-placement="bottom">ðŸ—‘</button>
                <button class="btn btn-outline-secondary btn-sm" type="submit" name="operation" value="delete-unverified" title="Delete all unverified users" data-bs-toggle="tooltip" data-bs-placement="bottom">ðŸ§¹</button>
                <input type="hidden" name="searchQuery" value="@Model.SearchQuery" />
                <div class="ms-auto d-flex flex-wrap align-items-center gap-2">
                    <input id="usersSearchQuery" class="form-control form-control-sm" type="search" value="@Model.SearchQuery" placeholder="Search by name or e-mail" aria-label="Search by name or e-mail" autocomplete="off" autofocus />
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover table-sm mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th class="checkbox-cell" scope="col">
                                <input id="selectAll" class="form-check-input" type="checkbox" aria-label="Select all users" />
                            </th>
                            <th scope="col">Name</th>
                            <th scope="col">E-mail</th>
                            <th scope="col">
                                Last login
                                <span class="text-secondary">â†“</span>
                            </th>
                            <th scope="col">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in Model.Users)
                        {
                            var badgeClass = user.Status switch
                            {
                                "active" => "text-bg-success",
                                "blocked" => "text-bg-danger",
                                _ => "text-bg-warning"
                            };

                            <tr>
                                <td class="checkbox-cell">
                                    <input class="form-check-input row-selector" type="checkbox" name="selectedIds" value="@user.Id" checked="@user.IsSelected" aria-label="Select @user.Email" />
                                </td>
                                <td>@user.Name</td>
                                <td>@user.Email</td>
                                <td class="text-nowrap">@user.LastActivity</td>
                                <td><span class="badge @badgeClass">@user.Status</span></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </form>
</section>

@section Scripts {
    <script>
        (() => {
            const selectAll = document.getElementById("selectAll");
            const rowSelectors = document.querySelectorAll(".row-selector");
            const selectionActions = document.querySelectorAll(".toolbar-selection-action");
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            const usersSearchQuery = document.getElementById("usersSearchQuery");
            const getUniqIdValue = () => `${Date.now()}-${Math.random().toString(36).slice(2, 10)}`;
            let searchDebounceId;

            [...tooltipTriggerList].forEach(element => {
                new bootstrap.Tooltip(element);
            });

            if (usersSearchQuery) {
                usersSearchQuery.focus();
                const searchQueryLength = usersSearchQuery.value.length;
                usersSearchQuery.setSelectionRange(searchQueryLength, searchQueryLength);

                usersSearchQuery.addEventListener("input", () => {
                    window.clearTimeout(searchDebounceId);
                    searchDebounceId = window.setTimeout(() => {
                        const nextValue = usersSearchQuery.value.trim();
                        const currentUrl = new URL(window.location.href);
                        if (nextValue.length === 0) {
                            currentUrl.searchParams.delete("searchQuery");
                        } else {
                            currentUrl.searchParams.set("searchQuery", nextValue);
                        }

                        window.location.assign(`${currentUrl.pathname}${currentUrl.search}`);
                    }, 350);
                });
            }

            if (!selectAll) {
                return;
            }

            const syncSelectAll = () => {
                const total = rowSelectors.length;
                const checked = [...rowSelectors].filter(input => input.checked).length;
                selectAll.checked = total > 0 && checked === total;
                selectAll.indeterminate = checked > 0 && checked < total;
                selectionActions.forEach(button => {
                    button.disabled = checked === 0;
                });
            };

            selectAll.addEventListener("change", () => {
                rowSelectors.forEach(input => {
                    input.checked = selectAll.checked;
                });
                selectAll.indeterminate = false;
            });

            rowSelectors.forEach(input => {
                input.addEventListener("change", syncSelectAll);
            });

            syncSelectAll();
            selectAll.dataset.syncId = getUniqIdValue();
        })();
    </script>
}
